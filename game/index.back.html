<!DOCTYPE html>
<html>
	<head>
		<title>Canvas</title>
		<style type="text/css">
			*:not(script):not(head) {
				margin: 0;
				padding: 0;
				display: inline-block;
			}
			body, html {
				width: 100%;
				height: 100%;
			}
			#container {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
			}
			canvas {
				border: 1px solid black;
			}
		</style>
	</head>
	<body>
		<div id="container">
			<input id="player" type="text">
			<button id="play">Jouer</button>
			<canvas id="canvas" width="1000" height="500"></canvas>
		</div>
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>
		<script type="text/javascript">
			var currentPlayer;
			var socket 		= io();
			var container 	= document.getElementById("container");
			var canvas 		= document.getElementById("canvas");
			var board 		= canvas.getContext("2d");
			var h 			= canvas.height;
			var w 			= canvas.width;
			var floor = h - 50;
			var elements = [];

			// EVENTS

			document.addEventListener("keydown", (e) => {
				handlePlayerMovements(true, e);

				// Tir
				if(e.keyCode === 32) {
					currentPlayer.firing(true);
				}
			});

			document.addEventListener("keyup", (e) => {
				handlePlayerMovements(false, e);

				// Tir
				if(e.keyCode === 32) {
					currentPlayer.firing(false);
				}
			});

			function handlePlayerMovements(active, event) {
				if(typeof currentPlayer === "undefined") {http://localhost:8079/
					return;
				}

				if(event.keyCode === 38) {
					currentPlayer.jump(active);
				}
				else if(event.keyCode === 37 || event.keyCode === 39) {
					currentPlayer.walk(active, event.keyCode === 37 ? "left" : "right");
				}
			}

			document.getElementById("play").addEventListener("click", (e) => {
				var name = document.getElementById("player").value;

				socket.emit("player-connect", {
					id: socket.id,
					name: name
				});

				currentPlayer = new Player(socket.id, name, true);
			});

			// SOCKETS

			socket.on("player-connect", data => {
				new Player(data.id, data.name);
			});

			socket.on("show-players", data => {
				for(var id in data) {
					new Player(id, data[id].name);
				}
			});

			socket.on("player-disconnect", id => {
				elements = elements.filter(element => !element.is('Player') || element.getId() !== id);
			});

			socket.on("player-update", data => {
				for(var i in elements) {
					if(elements[i].is('Player') && elements[i].getId() === data.id) {
						elements[i].setXY(data.x, data.y);
						break;
					}
				}
			});

			// FUNCTIONS

			function Player(id, name, current = false) {
				var player = this;

				player.init = function(name) {					
					Object.assign(player, new Element(player));
					Object.assign(player, new Moving(player));
					Object.assign(player, new Weapons(player));

					player.currentPlayer = current;
					player.id = id;
					player.width = 25;
					player.height = 25;
					player.name = name;
					player.speed = 5;
					player.initialSpeed = player.speed;
					player.jumpingFromKeyDown = false;
					player.onMove = false;
					player.keydown = {
						left: false,
						right: false,
						jump: false
					};

					player.setXY(50, floor - player.getWidth() * 2);
					player.draw();
				}

				player.getId = function() {
					return player.id;
				}
				player.getName = function() {
					return player.name;
				}
				player.isCurrentPlayer = function() {
					return player.currentPlayer;
				}

				player.draw = function() {
					player.setMovements();
					player.setWeapons();

					player.stopWalling();
					player.verifyKeyDowns();
					player.print();
				}
 
				player.stopWalling = function() {
					if(!player.getCurrentPlateform()) {
						var plateform = player.getColision();

						if(plateform && (player.getY() > plateform.getHitBoxY() || player.getHitBoxY() < plateform.getY())) {
							player.removeColision();
						}
					}
				}

				player.verifyKeyDowns = function() {
					var side = player.keydown.left ? 'left' : (player.keydown.right ? 'right' : false);

					// Saut permanent
					if(player.keydown.jump && !player.getColision()) {
						player.jumpingFromKeyDown = true;
						player.jump(true);
					}

					// On autorise le déplacement après une colision
					if(side && !player.getColision(side) && !player.hasWallJump()) {
						player.walk(true, side);
					}
				}

				player.print = function() {
					board.font = "15px Comic Sans MS";
					board.fillStyle = "black";
					board.textAlign = "center";
					board.fillText(player.name, player.getX() + player.getWidth() / 2, player.getY() - 10);
					board.fillRect(player.getX(), player.getY(), player.getWidth(), player.getWidth());
				}

				player.init(name);
			}

			function BadGuy(x, y, health) {
				var guy = this;

				guy.init = function() {
					Object.assign(guy, new Element(guy));
					Object.assign(guy, new Moving(guy));
					Object.assign(guy, new Weapons(guy));

					guy.x = 50;
					guy.y = floor - guy.getWidth() * 2;
					guy.width = 25;
					guy.height = 25;
					guy.health = health;
					guy.totalHealth = health;
					guy.isDead = false;

					guy.draw();
				}

				guy.injured = function(amount) {
					guy.health -= amount;

					if(guy.health <= 0) {
						guy.isDead = true;
					}
				}

				guy.draw = function() {
					guy.setMovements();
					guy.setWeapons();

					board.fillStyle = "red";
					board.fillRect(guy.getX() + guy.getWidth() / 2 - 50 / 2, guy.getY() - guy.getWidth() / 2, 50, 10);
					board.fillStyle = "green";
					board.fillRect(guy.x + guy.getWidth() / 2 - 50 / 2, guy.getY() - guy.getWidth() / 2, 50 * ( guy.health / guy.totalHealth ), 10);
					board.fillStyle = "black";
					board.fillRect(guy.getX(), guy.getY(), guy.getWidth(), guy.getWidth());
				}

				guy.init();
			}

			/**
			 *	FONCTIONS
			 */

			function setPlateform(x, y, width, height) {
				if(width < 0) {
					width = -width;
					x -= width;
				}

				if(height < 0) {
					height = -height;
					y -= height;
				}

				new Plateform(x, y, width, height);
			}

			function initGame() {
				board.clearRect(0, 0, w, h);

				for(var i in elements) {
					var element = elements[i];

					if(element.is('BadGuy') && element.isDead) {
						continue;
					}

					element.draw();
				}

				setTimeout(initGame, 15);
			}

			currentPlayer = new Player(0, 'Test', true);

			// Floor
			setPlateform(0, floor, w, 50);

			// Plateforms
			setPlateform(w / 2 - 100, h - 150, 150, 25);
			setPlateform(w / 2 + 100, h - 125, 75, 15);

			// Wall
			setPlateform(w * 90 / 100, floor - 100, 35, -100);
			setPlateform(w * 75 / 100, floor - 175, 35, -100);

			initGame();












			/* CONSTRUCTORS */

			function Element(element) {
				var object = this;

				object.is = function(constructor) {
					return element.constructor.name === constructor;
				}
				object.setX = function(x) {
					// if(object.is('Player') && element.isCurrentPlayer()) {
					// 	var distance = object.getX() - w / 2;

					// 	if(distance > 0) {
					// 		distance = 7.5;
					// 	}
					// 	else {
					// 		object.setXY(x, object.getY());
					// 		distance = 0;
					// 	}

					// 	for(var i in elements) {
					// 		if(elements[i].is('Plateform')) {
					// 			elements[i].setX(elements[i].getX() + distance * object.getFacingOperator() * -1);
					// 		}
					// 	}
					// }
					// else {
						object.setXY(x, object.getY());
					// }
				}
				object.setY = function(y) {
					object.setXY(object.getX(), y);
				}
				object.setXY = function(x, y) {
					element.x = x;
					element.y = y;

					if(object.is('Player') && element.isCurrentPlayer()) {
						socket.emit("player-update", {x: x, y: y});
					}
				}
				object.getX = function() {
					return element.x - (object.is('Bullet') ? object.getWidth() / 2 : 0);
				}
				object.getHitBoxX = function() {
					return object.getX() + object.getWidth();
				}
				object.getY = function() {
					return element.y - (object.is('Bullet') ? object.getWidth() / 2 : 0);
				}
				object.getHitBoxY = function() {
					return object.getY() + object.getHeight();
				}
				object.getFacing = function() {
					return element.facing;
				}
				object.getFacingOperator = function() {
					return element.facing === 'left' ? -1 : 1;
				}

				object.getWidth = function() {
					return element.width;
				}
				object.getHeight = function() {
					return element.height;
				}

				elements.push(element);
			}

			function Moving(character) {

				character.init = function() {
					character.vy = 1;
					character.currentPlateform = false;
					character.currentPlateformIndex = 0;
					character.walking = false;
					character.facing = 'right';
					character.wallJump = false;
					character.colision = {
						left: false,
						right: false
					};
				}

				// SETTERS

				character.setVelocity = function(v) {
					character.vy = v;
				}
				character.setFacing = function(side) {
					character.facing = side;
				}
				character.setSpeed = function(speed) {
					character.speed = speed;
				}
				character.setColision = function(side, value) {
					character.colision[side] = value;
				}
				character.removeColision = function() {
					character.colision.left = false;
					character.colision.right = false;
				}
				character.setCurrentPlateform = function(value) {
					character.currentPlateform = value;
				}
				character.setMovements = function() {
					character.setSiblingsPlateforms();
					character.isWalking();
					character.onGround();
				}
				character.setWalking = function(walking) {
					character.walking = walking;
				}
				character.setWallJump = function(side) {
					if(!side) {
						character.setSpeed(character.getSpeed());
						character.setWalking(false);
					}
					else {
						// character.setSpeed(character.getSpeed() * -1);
						character.setWalking(true);
					}
					character.wallJump = side;
				}
				character.setSiblingsPlateforms = function() {
					character.siblingsPlateforms = elements.filter(function(element) {
						return element.is('Plateform') && character.getHitBoxX() + 10 > element.getX() && character.getX() - 10 < element.getHitBoxX();
					});
				}

				// GETTERS

				character.getVelocity = function() {
					return character.vy;
				}
				character.getSpeed = function() {
					return character.speed;
				}
				character.getOppositeFacing = function() {
					return character.facing === 'left' ? 'right' : 'left';
				}
				character.getColision = function(side = false) {
					if(!side) {
						if(character.colision.left) {
							return character.colision.left;
						}
						else if(character.colision.right) {
							return character.colision.right;
						}
						else {
							return false;
						}
					}
					else {
						return character.colision[side];
					}
				}
				character.getColisionSide = function() {
					if(character.colision.left) {
						return 'left';
					}
					else {
						return 'right';
					}
				}
				character.getCurrentPlateform = function() {
					return character.currentPlateform;
				}

				// Prototypes

				character.jump = function(jumping) {
					var colision = character.getColision();

					if(character.is('Player')) {
						character.keydown.jump = jumping;
					}

					if(jumping) {
						if(character.getCurrentPlateform() || (colision && character.isWallCLimbing(character.getColisionSide()))) {
							if(character.is('Player') && !character.getCurrentPlateform()) {
								character.removeColision();
								character.setFacing(character.getOppositeFacing());
								character.setWallJump(character.getFacing());
								character.setWalking(true);
							}

							character.setCurrentPlateform(false);
							character.currentPlateformIndex = 0;
							character.setVelocity(-15);
						}
					}
				}

				character.walk = function(walking, side = false) {
					if(character.is('Player')) {
						character.keydown[side] = walking;

						var opposite = side === 'left' ? 'right' : 'left';

						// Si appui des touches directionnelles constant
						// On vérifie si une touche est toujours appuyée
						if(!walking) {
							if((side === "left" && character.keydown.right) || (side === "right" && character.keydown.left)) {
								side = opposite;
								walking = true;
							}
							if(character.hasWallJump()) {
								walking = true;
								side = character.getFacing();
							}
						}

						if(character.getColision(side)) {
							walking = false;
						}
						else {
							character.removeColision();
						}

						if(walking && character.hasWallJump() && character.getSpeed() < 5 && side === character.hasWallJump()) {
							character.setSpeed(Math.abs(character.getSpeed()));
						}
					}

					character.setFacing(side);
					character.setWalking(walking);
				}

				// Helpers

				character.isConstuctor = function(constructor) {
					return character.constructor.name === constructor;
				}

				character.hasWallJump = function() {
					return character.wallJump;
				}
				character.isWallCLimbing = function(side) {
					return character.getColision(side) && character.keydown[side];
				}

				character.isWalking = function() {
					if(character.is('Player') && character.getSpeed() < 5) {
						character.setSpeed(character.getSpeed() + 0.15);
					}

					if(character.walking) {
						character.setX(character.getX() + character.getSpeed() * character.getFacingOperator());

						character.setSiblingsPlateforms();
						character.onHitWall();
						character.isFalling();
					}
				}

				character.onGround = function() {
					if(!character.getCurrentPlateform()) {
						// Walling
						if(character.is('Player') && (character.isWallCLimbing('left') || character.isWallCLimbing('right'))) {
							character.setVelocity(1.5);
						}
						// Jumping
						else {
							character.setVelocity(character.getVelocity() + 1);
						}

						character.setY(character.getY() + character.getVelocity());
						character.isTouchingGround();

						if(character.getY() > floor) {
							character.setXY(50, h / 2);
						}
					}
				}

				character.isFalling = function() {
					var plateform = character.getCurrentPlateform();

					if(plateform && (character.getHitBoxX() < plateform.getX() || character.getX() > plateform.getHitBoxX())) {
						character.setCurrentPlateform(false);
						character.currentPlateformIndex = 0;
						character.setVelocity(0);
					}
				}

				character.isTouchingGround = function() {
					for(var i in character.siblingsPlateforms) {
						var plateform = character.siblingsPlateforms[i];

						// Ouch la tête ...
						if(character.getVelocity() < 0 &&
							character.getHitBoxX() > plateform.getX() && 
							character.getX() < plateform.getHitBoxX() &&
							character.getHitBoxY() > plateform.getHitBoxY() &&
							character.getY() <= plateform.getHitBoxY()
						) {
							character.setY(plateform.getHitBoxY());
							character.setVelocity(0);

							break;
						}
						// Plateforme sous nos pieds ?
						else if(character.getVelocity() > 0 &&
							character.getHitBoxX() > plateform.getX() && 
							character.getX() < plateform.getHitBoxX() &&
							character.getHitBoxY() >= plateform.getY() &&
							character.getY() <= plateform.getY()
						) {
							character.setWallJump(false);
							character.setCurrentPlateform(plateform);
							character.currentPlateformIndex = i;

							character.setY(plateform.getY() - character.getWidth());
							character.setVelocity(0);

							break;
						}
					}
				}

				character.onHitWall = function() {
					for(var i in character.siblingsPlateforms) {
						var plateform = character.siblingsPlateforms[i];

						if(i > 0 &&
							character.currentPlateformIndex !== i &&
							character.getHitBoxX() > plateform.getX() && 
							character.getX() < plateform.getHitBoxX() &&
							character.getHitBoxY() > plateform.getY() &&
							character.getY() < plateform.getHitBoxY()
						) {
							character.setWalking(false);

							// Colision right
							if(character.getX() < plateform.getX()) {
								character.setColision('right', plateform);
								character.setX(plateform.getX() - character.getWidth());
							}
							// Colision left
							else {
								character.setColision('left', plateform);
								character.setX(plateform.getHitBoxX());
							}
						}
					}
				}

				character.init();
			}

			function Weapons(character) {
				character.bullets = [];
				character.isFiring = false;
				character.speedFire = 0;

				character.fire = function() {
					if(character.isFiring && character.speedFire === 0) {
						character.speedFire = setTimeout(() => {
							var facing = character.getFacing();
							var start = facing === 'left' ? character.getX() : character.getHitBoxX();

							if(character.getColision(facing)) {
								facing = character.getOppositeFacing();
							}

							character.bullets.push(new Bullet(character, start, character.getY() + character.getWidth() / 2, facing, 8));

							character.speedFire = 0;
						}, 100);
					}
				}

				character.firing = function(firing) {
					character.isFiring = firing;
				}

				character.setWeapons = function() {
					character.fire();

					for(var i in character.bullets) {
						if(!character.bullets[i].draw()) {
							character.bullets.shift();
						}
					}
				}
			}

			function Bullet(character, x, y, direction, speed) {
				var bullet = this;

				Object.assign(bullet, new Element(bullet));

				bullet.width = 5;
				bullet.height = bullet.width;
				bullet.shooter = character;
				bullet.x = x;
				bullet.y = y;
				bullet.speed = speed;
				bullet.facing = direction;
				bullet.dommage = 5;

				bullet.getDommage = function() {
					return bullet.dommage;
				}
				bullet.getShooter = function() {
					return bullet.shooter;
				}

				bullet.draw = function() {
					bullet.setX();

					if(bullet.getX() > w + 100 || bullet.getX() < -100 || bullet.onHit()) {
						return false;
					}

					bullet.print();
					return true;
				}

				bullet.onHit = function() {
					for(var i in elements) {
						var element = elements[i];

						if(
							(
								(bullet.getHitBoxY() < element.getHitBoxY() && bullet.getHitBoxY() > element.getY()) ||
								(bullet.getY() < element.getHitBoxY() && bullet.getY() > element.getY())
							) 
							&& 
							(
								(bullet.getFacing() === 'right' && bullet.getHitBoxX() > element.getX() && bullet.getHitBoxX() < element.getHitBoxX()) ||
								(bullet.getFacing() === 'left' && bullet.getX() < element.getHitBoxX() && bullet.getX() > element.getX())
							)
						) {
							if(element._enemy) {
								element.object.injured(bullet.getDommage());
							}

							return true;
						}
					}
				}

				bullet.print = function() {
					board.beginPath();
					board.fillStyle = 'silver';
					board.arc(bullet.getX(), bullet.getY(), bullet.width, 0, Math.PI * 2);
					board.fill();
				} 

				return bullet;
			}

			function Plateform(x, y, width, height) {
				var plateform = this;

				Object.assign(plateform, new Element(plateform));

				plateform.width = width;
				plateform.height = height;
				plateform.x = x;
				plateform.y = y;

				plateform.draw = function() {	
					board.fillStyle = "lightgreen";
					board.fillRect(plateform.getX(), plateform.getY(), plateform.getWidth(), plateform.getHeight());
				}
			}

		</script>
	</body>
</html>